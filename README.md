# nippo-spec

「nippo」は地理院タイル1枚1枚の更新情報を記述したファイルです。
「nippo」の仕様は以下の通りです。

## ファイル内容

```
    （パス）,（最終更新時刻）,（サイズ）,（MD5SUM）
```

最終更新時刻(mtime)は、UNIX起算時を整数化したものとしています。
パスからURLへの換算は、`https://cyberjapandata.gsi.go.jp/xyz/（パス）` です。
基本的な書式は、[mokuroku](https://github.com/gsi-cyberjapan/mokuroku-spec)と同じですが、nippoの場合は、（パス）にタイルIDを含む点が異なります。

例：`https://cyberjapandata.gsi.go.jp/xyz/pale/11/1826/793.png` に対する「mokuroku」と「nippo」のレコードは次の通りとなります（2020年12月現在）。

mokuroku
```
    11/1826/793.png,1600150263,22021,493b024eb6046319e1eca362ac9ec804
```

nippo
```
    pale/11/1826/793.png,1600150263,22021,493b024eb6046319e1eca362ac9ec804
```


この違いは、mokurokuは、タイルIDごとに1ファイルであるのに対し、nippoは複数のタイルIDの情報を1ファイルに含んでいるためです。
別の言い方をすれば、mourokuの場合は、mokurokuファイルのURLからタイルIDが分かりますが、nippoはnippoのファイル名からもURLからもタイルIDが分からないためです。


## nippoが対象とするタイルID

現時点において、nippoが対象とするタイルIDは「std」「pale」「english」のみです。それ以外のタイルIDの更新情報は含まれておりません。


## nippoファイルのURL

「nippo」ファイルのURLは以下の通りです。

```https://cyberjapandata.gsi.go.jp/nippo/(yyyymmdd)-nippo.csv.gz```

「yyyymmdd」はnippoファイルを公開した日付です。

（例：`https://cyberjapandata.gsi.go.jp/nippo/20200920-nippo.csv.gz`）


## nippoファイルの公開・削除のスケジュール

* nippoファイルには、原則として前日に更新したタイルの情報が記述され、午前4時（日本時間、以下同じ）までに公開されます。
ただし、場合によっては一部前日の情報が含まれない場合があります。その場合は、更に翌日のnippoファイルに更新情報が記載されます。

* また、場合によっては当日の更新情報が記載される場合があります。

* 更新のタイルが多い場合は公開が4時を過ぎる場合があります。

* タイルの更新がなかった場合、その翌日はnippoファイルは公開されません。その場合、ダウンロードしようとしても、ステータス404 Not Foundとなります。

* nippoファイルは、毎月11日に前月の1日～31日分のものがサーバから削除されます。


## nippoファイルの活用例

mokurokuとnippoを併用することで、お手元にダウンロードするタイルデータを最新に保つことができます。


「std」「pale」「english」のmokurokuは前月末時点タイルの情報が記述されたものが翌月10日までに公開されている（2020年12月現在）ので、以下のようにすることで、お手元にダウンロードするタイルデータを最新に保つことができます。


例として、12月3日にタイルデータを初回ダウンロードし、その後、お手元のタイルデータを最新に保つにはどのようにすれば良いかを考えてみます。

<ol>
 <li>
【12月3日】mokuroku（10月31日時点の情報が記述されている）をダウンロード。さらに11月1日、11月2日・・・11月30日、12月1日、12月2日、12月3日のnippoをダウンロード。これらを順に合成して最新のファイルリスト（「ファイルリストA」と呼びます）を作成する。ファイルリストAをもとにタイルデータをダウンロードする。
   
※この作業を行うことで、12月2日時点の地図データを手元に置くことができるようになる。
 </li><li>
【12月4日～12月10日】毎日nippoをダウンロードし、それに基づいて都度1でダウンロードしたデータに上書きする。
  
※この作業を行うことで、毎日、前日時点の地図データを手元に置くことができる。

 </li><li>
  【12月11日】お手元のmokurokuと11月1日～12月11日のnippoを順に合成し、最新と思われるファイルリスト（「ファイルリストX」と呼びます）を作成する。また、新たにダウンロードしたmokuroku（11月30日時点の情報が記述されている）と12月1日～12月11日のnippoを順に合成し、最新と思われるファイルリスト（「ファイルリストY」と呼びます。）を作成する。

原理的にはファイルリストXとファイルリストYは一致するはずだが、もし一致していなかった場合は、一致していなかったタイルデータをファイルリストYをもとにダウンロードし、1でダウンロードしたデータに上書きする。

※この作業を行うことで、毎日のnippoによる更新に漏れがあった場合でも修正することができる。
 </li><li>
【12月12日～1月10日】2と同様の作業を行う。
 </li><li>
【1月11日】3と同様の作業を行う。
 </li><li>
【以後】4と5を繰り返す。
 </li>
</ol>


## 注意事項
* 本レポジトリ及び「nippo」は実験的に提供しているものです。動作保証は行っておりません。予告なく内容、提供方法等を変更する可能性や提供を中断する可能性があります。
* 本レポジトリ及び「nippo」の利用により生じた損失及び損害等について、国土地理院はいかなる責任も負わないものとします。

